<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>아미노산 조합 학습</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }
    .button-container {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    #result-container {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
      min-height: 1.4em;
    }
    #structure-container {
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>아미노산 조합 학습</h1>

  <div class="button-container">
    <button onclick="appendSequence('G')">G</button>
    <button onclick="appendSequence('C')">C</button>
    <button onclick="appendSequence('A')">A</button>
    <button onclick="appendSequence('U')">U</button>
  </div>

  <div>
    조합된 염기 서열: <span id="sequence"></span>
  </div>

  <div class="button-container">
    <button onclick="checkAminoAcid()">결과 확인</button>
    <button onclick="resetSequence()">초기화</button>
  </div>

  <div id="result-container"></div>
  <div id="structure-container"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.128.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';
    import { PDBLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/PDBLoader.js';

    const sequenceDisplay = document.getElementById('sequence');
    const resultDisplay = document.getElementById('result-container');
    const structureContainer = document.getElementById('structure-container');

    const aminoAcidMap = {
      'GGG': '글라이신', 'GGA': '글라이신', 'GGU': '글라이신', 'GGC': '글라이신',
      'GCU': '알라닌', 'GCC': '알라닌', 'GCA': '알라닌', 'GCG': '알라닌',
      'GUU': '발린', 'GUC': '발린', 'GUA': '발린', 'GUG': '발린',
      'UUA': '류신', 'UUG': '류신', 'CUU': '류신', 'CUC': '류신',
      'CUA': '류신', 'CUG': '류신', 'AUU': '아이소류신', 'AUC': '아이소류신',
      'AUA': '아이소류신', 'AUG': '메티오닌', 'UUU': '페닐알라닌', 'UUC': '페닐알라닌',
      'UAU': '티로신', 'UAC': '티로신', 'UGG': '트립토판',
      'UCU': '세린', 'UCC': '세린', 'UCA': '세린', 'UCG': '세린', 'AGU': '세린', 'AGC': '세린',
      'ACU': '트레오닌', 'ACC': '트레오닌', 'ACA': '트레오닌', 'ACG': '트레오닌',
      'UGU': '시스테인', 'UGC': '시스테인',
      'CCU': '프롤린', 'CCC': '프롤린', 'CCA': '프롤린', 'CCG': '프롤린',
      'CAU': '히스티딘', 'CAC': '히스티딘', 'CAA': '글루타민', 'CAG': '글루타민',
      'AAU': '아스파라긴', 'AAC': '아스파라긴', 'AAA': '라이신', 'AAG': '라이신',
      'GAU': '아스파르트산', 'GAC': '아스파르트산', 'GAA': '글루탐산', 'GAG': '글루탐산',
      'CGU': '아르기닌', 'CGC': '아르기닌', 'CGA': '아르기닌', 'CGG': '아르기닌', 'AGA': '아르기닌', 'AGG': '아르기닌',
      'UAA': '종결코돈', 'UAG': '종결코돈', 'UGA': '종결코돈'
    };

    let currentSequence = '';

    let scene, camera, renderer, controls;
    const loader = new PDBLoader();

    function init3D() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, structureContainer.clientWidth / structureContainer.clientHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(structureContainer.clientWidth, structureContainer.clientHeight);
      structureContainer.appendChild(renderer.domElement);

      camera.position.z = 5;

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.2;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 2.0;

      // 조명 추가
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function appendSequence(nucleotide) {
      if (currentSequence.length < 3) {
        currentSequence += nucleotide;
        sequenceDisplay.textContent = currentSequence;
      }
    }
    window.appendSequence = appendSequence;

    function resetSequence() {
      currentSequence = '';
      sequenceDisplay.textContent = '';
      resultDisplay.textContent = '';
      clearStructure();
    }
    window.resetSequence = resetSequence;

    function checkAminoAcid() {
      if (currentSequence.length !== 3) {
        resultDisplay.textContent = '3개의 염기 서열을 조합하여 확인해 주세요.';
        clearStructure();
        return;
      }

      if (aminoAcidMap.hasOwnProperty(currentSequence)) {
        const aminoAcidName = aminoAcidMap[currentSequence];
        resultDisplay.textContent = `조합된 아미노산: ${aminoAcidName}`;
        updateAminoAcidStructure(aminoAcidName);
      } else {
        resultDisplay.textContent = '해당하는 아미노산을 찾을 수 없습니다.';
        clearStructure();
      }
    }
    window.checkAminoAcid = checkAminoAcid;

    function clearStructure() {
      const existing = scene.getObjectByName('aminoAcidStructure');
      if (existing) {
        scene.remove(existing);
      }
      camera.position.set(0, 0, 5);
      controls.target.set(0, 0, 0);
      controls.update();
    }

    function updateAminoAcidStructure(aminoAcidName) {
      const pdbFile = `pdb_files/${aminoAcidName.toLowerCase()}.pdb`;

      loader.load(
        pdbFile,
        (pdb) => {
          clearStructure();

          // pdb.geometryAtoms는 PDBLoader에서 파싱한 원자 위치 등 데이터
          const geometryAtoms = pdb.geometryAtoms;
          const geometryBonds = pdb.geometryBonds;

          const group = new THREE.Group();
          group.name = 'aminoAcidStructure';

          // 원자 그리기
          geometryAtoms.forEach(atom => {
            const atomGeometry = new THREE.SphereGeometry(0.2, 16, 16);
            const atomMaterial = new THREE.MeshPhongMaterial({ color: 0x00cc00 });
            const atomMesh = new THREE.Mesh(atomGeometry, atomMaterial);
            atomMesh.position.copy(atom.position);
            group.add(atomMesh);
          });

          // 결합 그리기
          geometryBonds.forEach(bond => {
            const start = bond.start;
            const end = bond.end;
            const bondGeometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
              start.x, start.y, start.z,
              end.x, end.y, end.z
            ]);
            bondGeometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            const bondMaterial = new THREE.LineBasicMaterial({ color: 0x0000cc });
            const bondLine = new THREE.Line(bondGeometry, bondMaterial);
            group.add(bondLine);
          });

          scene.add(group);
        },
        undefined,
        (error) => {
          console.error('PDB 파일 로드 실패:', error);
          resultDisplay.textContent = '3D 구조 로딩에 실패했습니다.';
        }
      );
    }

    // 초기화 및 애니메이션 시작
    init3D();
    animate();

  </script>
</body>
</html>
